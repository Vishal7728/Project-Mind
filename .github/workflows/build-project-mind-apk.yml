name: Build Project Mind APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  # Android SDK configuration
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.1.8387110
  GRADLE_USER_HOME: ~/.gradle
  GRADLE_OPTS: -Xmx2048m -XX:MaxMetaspaceSize=512m

jobs:
  validate:
    name: Validate Project Setup
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Create pip cache directory
      run: |
        mkdir -p /tmp/pip-cache
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
      env:
        PIP_CACHE_DIR: /tmp/pip-cache

    - name: Run Build Validation
      run: |
        python validate_build.py

  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 60
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Setup Java (Required for Android builds)
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
      env:
        JAVA_OPTS: -Xmx2048m

    # Setup Python (Required for Buildozer)
    - name: Create pip cache directory if missing
      run: mkdir -p /home/runner/.cache/pip

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    # Install Android SDK Components
    - name: Install Android SDK Components
      run: |
        echo "Installing Android SDK tools..."
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        
        # Download SDK tools if not cached
        if [ ! -d "$ANDROID_SDK_ROOT/cmdline-tools/latest" ]; then
          echo "Downloading Android SDK Command-line Tools..."
          cd $ANDROID_SDK_ROOT/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip
          unzip -q commandlinetools-linux-10406996_latest.zip
          mv cmdline-tools latest
          rm commandlinetools-linux-10406996_latest.zip
        fi
        
        # Set PATH
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
        
        # Accept licenses
        echo "Accepting Android SDK licenses..."
        yes | sdkmanager --licenses 2>/dev/null || true
        
        # Install required packages
        echo "Installing SDK packages..."
        sdkmanager --install "platforms;android-33" --verbose 2>&1 | grep -i "installed" || true
        sdkmanager --install "build-tools;33.0.0" --verbose 2>&1 | grep -i "installed" || true
        sdkmanager --install "platform-tools" --verbose 2>&1 | grep -i "installed" || true
        sdkmanager --install "ndk;25.1.8387110" --verbose 2>&1 | grep -i "installed" || true
        
        # Verify installations
        echo "Verifying Android SDK installations..."
        ls -la $ANDROID_SDK_ROOT/platforms/ || echo "Platforms not found"
        ls -la $ANDROID_SDK_ROOT/build-tools/ || echo "Build-tools not found"
        ls -la $ANDROID_SDK_ROOT/ndk/ || echo "NDK not found"

    # Verify Environment Variables
    - name: Verify Environment Setup
      run: |
        echo "================================"
        echo "ENVIRONMENT VERIFICATION"
        echo "================================"
        echo ""
        
        # Java version
        echo "Java Version:"
        java -version
        echo ""
        
        # Python version
        echo "Python Version:"
        python --version
        echo ""
        
        # Android SDK
        echo "Android SDK Root: $ANDROID_SDK_ROOT"
        ls -la $ANDROID_SDK_ROOT/ 2>/dev/null | head -10 || echo "SDK not found"
        echo ""
        
        # Android NDK
        echo "Android NDK Home: $ANDROID_NDK_HOME"
        ls -la $ANDROID_NDK_HOME/ 2>/dev/null | head -5 || echo "NDK not found"
        echo ""
        
        # Gradle
        echo "Gradle user home: $GRADLE_USER_HOME"
        echo "Gradle options: $GRADLE_OPTS"
        echo ""
        
        # buildozer.spec
        echo "buildozer.spec exists:"
        test -f buildozer.spec && echo "YES - $(wc -l < buildozer.spec) lines" || echo "NO - CRITICAL ERROR"
        echo ""
        
        echo "================================"

    # Cache Gradle (Speed up builds)
    - name: Cache Gradle Files
      uses: actions/cache@v4
      continue-on-error: true
      with:
        path: ~/.gradle/caches
        key: gradle-${{ runner.os }}-project-mind-${{ github.run_id }}
        restore-keys: |
          gradle-${{ runner.os }}-project-mind-
          gradle-${{ runner.os }}-

    # Cache Android SDK (Speed up builds)
    - name: Cache Android SDK
      uses: actions/cache@v4
      continue-on-error: true
      with:
        path: /usr/local/lib/android/sdk
        key: android-sdk-${{ runner.os }}-api-33-ndk-25b-${{ github.run_id }}
        restore-keys: |
          android-sdk-${{ runner.os }}-api-33-ndk-25b-
          android-sdk-${{ runner.os }}-

    # Install Buildozer and Dependencies
    - name: Install Buildozer and Dependencies
      run: |
        echo "Installing Python build dependencies..."
        python -m pip install --upgrade pip setuptools wheel
        
        # Install critical Cython version (MUST be 0.29.33 for Kivy)
        python -m pip install Cython==0.29.33 --no-cache-dir
        
        # Install Buildozer
        python -m pip install buildozer --no-cache-dir
        
        # Install Kivy and other requirements
        python -m pip install kivy pillow --no-cache-dir
        
        # Verify installations
        echo ""
        echo "Installed packages:"
        pip list | grep -E "buildozer|Cython|kivy|Pillow"
        echo ""
        echo "Buildozer version:"
        buildozer --version
        echo ""

    # Clean Previous Builds (Fresh start)
    - name: Clean Previous Builds
      run: |
        echo "Cleaning previous build artifacts..."
        buildozer android clean || echo "Clean completed"
        echo "Build clean complete"

    # Build Release APK (Main build step)
    - name: Build Release APK
      run: |
        echo "================================"
        echo "STARTING APK BUILD"
        echo "================================"
        echo ""
        echo "Build Configuration:"
        echo "  App Title: Project Mind - Living AI"
        echo "  Package: org.projectmind.projectmind"
        echo "  Version: 1.0.0"
        echo "  Target API: 33"
        echo "  Min API: 21"
        echo "  NDK: 25b"
        echo "  Architectures: arm64-v8a, armeabi-v7a"
        echo ""
        
        # Build with verbose output
        buildozer android release 2>&1 | tee build.log
        
        BUILD_EXIT=$?
        
        echo ""
        echo "================================"
        if [ $BUILD_EXIT -eq 0 ]; then
          echo "BUILD SUCCESSFUL"
          echo "Checking for APK generation indicators in build log:"
          grep -i "BUILD SUCCESSFUL" build.log || echo "No explicit success message found"
          grep -i "apk" build.log | tail -10 || echo "No APK references found in build log"
        else
          echo "BUILD FAILED - Exit code: $BUILD_EXIT"
          echo "Showing last 100 lines of build log:"
          tail -100 build.log
          exit $BUILD_EXIT
        fi
        echo "================================"

    # Verify APK Was Created
    - name: Verify APK Generation
      run: |
        echo "Checking for generated APK..."
        echo ""
        
        # Check expected locations
        echo "Checking bin/ directory:"
        if [ -d "bin" ]; then
          ls -lah bin/
          APK_COUNT=$(ls -1 bin/*.apk 2>/dev/null | wc -l)
          echo "APKs found: $APK_COUNT"
        else
          echo "bin/ directory not found"
        fi
        
        echo ""
        echo "Searching for APK in buildozer output:"
        find .buildozer -name "*.apk" -type f 2>/dev/null || echo "No APKs found in .buildozer"
        
        echo ""
        echo "Expected file: bin/projectmind-1.0.0-release.apk"
        if test -f bin/projectmind-1.0.0-release.apk; then
          echo "FOUND - Ready for upload"
        else
          echo "NOT FOUND - Checking alternative locations..."
          # Check if APK exists in build outputs
          find .buildozer -name "*.apk" -type f | head -5
        fi

    # Find and List All APK Files
    - name: Find and List APK Files
      if: always()
      run: |
        echo "Finding all APK files generated by the build:"
        echo ""
        find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
        echo ""
        echo "=== Detailed APK search ==="
        echo "Searching in bin/:"
        find bin/ -name "*.apk" -type f 2>/dev/null || echo "No APKs in bin/"
        echo ""
        echo "Searching in .buildozer/:"
        find .buildozer/ -name "*.apk" -type f 2>/dev/null || echo "No APKs in .buildozer/"
        echo ""
        echo "Full directory structure around APKs:"
        find . -path "./.git" -prune -o -name "*.apk" -type f -exec dirname {} \; 2>/dev/null | xargs -I {} ls -la {} 2>/dev/null || echo "No directories with APKs found"
    
    # Copy APK files to known location for artifact upload
    - name: Copy APK Files to Artifact Directory
      if: always()
      run: |
        echo "Copying APK files to artifact directory..."
        mkdir -p apk_artifacts
        find . -name "*.apk" -type f -exec cp {} apk_artifacts/ \; 2>/dev/null || echo "No APK files to copy"
        ls -la apk_artifacts/ 2>/dev/null || echo "Artifact directory not created or empty"
    
    # List Build Directory
    - name: List Build Output
      if: always()
      run: |
        echo "Build output directory structure:"
        echo ""
        echo "=== bin/ contents ==="
        ls -lah bin/ 2>/dev/null || echo "bin/ not found"
        echo ""
        echo "=== .buildozer/android/app/build/outputs/ ==="
        find .buildozer/android/app/build/outputs -type f -name "*.apk" 2>/dev/null | head -10 || echo "No outputs found"

    # Upload APK as Artifact
    - name: Upload APK Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: projectmind-apk-${{ github.run_number }}
        path: |
          **/projectmind-*.apk
          **/*.apk
          .buildozer/**/*release*.apk
          .buildozer/**/*debug*.apk
          bin/**/*.apk
          */*.apk
          apk_artifacts/*.apk
        retention-days: 30
        if-no-files-found: warn

    # Create Release (Optional - only on tags)
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/') && success()
      uses: softprops/action-gh-release@v1
      with:
        files: |
          **/projectmind-*.apk
          **/*.apk
          .buildozer/**/*release*.apk
          .buildozer/**/*debug*.apk
          bin/**/*.apk
          */*.apk
          apk_artifacts/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Build Summary
    - name: Build Summary
      if: always()
      run: |
        echo ""
        echo "======================================="
        echo "BUILD SUMMARY"
        echo "======================================="
        echo ""
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Run: ${{ github.run_id }}"
        echo ""
        
        # Look for APK in multiple locations
        APK_PATH=""
        if [ -f "bin/projectmind-1.0.0-release.apk" ]; then
          APK_PATH="bin/projectmind-1.0.0-release.apk"
        elif [ -f "bin/projectmind-1.0.0-debug.apk" ]; then
          APK_PATH="bin/projectmind-1.0.0-debug.apk"
        else
          # Try to find any APK
          APK_PATH=$(find . -name "projectmind-*.apk" -type f | head -1)
        fi
        
        if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "APK Status: SUCCESS"
          echo "APK File: $APK_PATH"
          echo "APK Size: $APK_SIZE"
          echo ""
          echo "Download from: GitHub Actions > Artifacts"
          echo "Install command: adb install -r $APK_PATH"
        else
          echo "APK Status: NOT CREATED"
          echo "Check logs above for build errors"
        fi
        
        echo ""
        echo "======================================="
        echo "Build Time: $(date)"
        echo "======================================="

# END OF WORKFLOW