name: Build APK - Production

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.1.8387110
  GRADLE_USER_HOME: ~/.gradle
  GRADLE_OPTS: -Xmx2048m -XX:MaxPermSize=512m

jobs:
  validate:
    name: Validate Project Setup
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Run Build Validation
      run: python scripts/validate_build.py

  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 60
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
      env:
        JAVA_OPTS: -Xmx2048m

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Android SDK Components
      run: |
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        if [ ! -d "$ANDROID_SDK_ROOT/cmdline-tools/latest" ]; then
          cd $ANDROID_SDK_ROOT/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip
          unzip -q commandlinetools-linux-10406996_latest.zip
          mv cmdline-tools latest
          rm commandlinetools-linux-10406996_latest.zip
        fi
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
        yes | sdkmanager --licenses 2>/dev/null || true
        sdkmanager --install "platforms;android-33" 2>&1 | grep -i "installed" || true
        sdkmanager --install "build-tools;33.0.0" 2>&1 | grep -i "installed" || true
        sdkmanager --install "platform-tools" 2>&1 | grep -i "installed" || true
        sdkmanager --install "ndk;25.1.8387110" 2>&1 | grep -i "installed" || true

    - name: Verify Environment
      run: |
        java -version
        python --version
        test -f buildozer.spec && echo "buildozer.spec found" || echo "ERROR: buildozer.spec missing"

    - name: Cache Gradle
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: gradle-${{ runner.os }}-api-33
        restore-keys: gradle-${{ runner.os }}-

    - name: Cache Android SDK
      uses: actions/cache@v3
      with:
        path: /usr/local/lib/android/sdk
        key: android-sdk-api-33-ndk-25b
        restore-keys: android-sdk-

    - name: Install Build Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install Cython==0.29.33
        python -m pip install buildozer kivy pillow

    - name: Clean Previous Builds
      run: buildozer android clean

    - name: Build Release APK
      run: buildozer android release 2>&1 | tee build.log

    - name: Verify APK
      run: test -f bin/projectmind-1.0.0-release.apk && echo "APK created successfully" || exit 1

    - name: Upload APK Artifact
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: projectmind-apk-${{ github.run_number }}
        path: bin/projectmind-*.apk
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        if [ -f "bin/projectmind-1.0.0-release.apk" ]; then
          echo "APK Status: SUCCESS"
          du -h bin/projectmind-1.0.0-release.apk
        else
          echo "APK Status: FAILED"
        fi
