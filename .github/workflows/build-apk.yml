name: Build APK - Production

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.1.8387110
  GRADLE_USER_HOME: ~/.gradle
  GRADLE_OPTS: -Xmx2048m -XX:MaxPermSize=512m

jobs:
  validate:
    name: Validate Project Setup
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Run Build Validation
      run: python validate_build.py

  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: validate
    # Increase timeout for cold runs (NDK/SDK downloads + native compile)
    timeout-minutes: 120
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
      env:
        JAVA_OPTS: -Xmx2048m

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install system packages (prereqs)
      run: |
        sudo apt-get update -y
        sudo apt-get install -y build-essential libssl-dev libffi-dev libjpeg-dev zlib1g-dev \
          libsdl2-dev libmtdev-dev libglu1-mesa-dev libgl1-mesa-dev pkg-config git wget unzip

    - name: Environment Diagnostics
      run: |
        echo "Runner: $(uname -a)"
        df -h || true
        free -m || true
        env | egrep 'ANDROID|JAVA|GRADLE|PYTHON' || true

    - name: Install Android SDK Components
      run: |
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        if [ ! -d "$ANDROID_SDK_ROOT/cmdline-tools/latest" ]; then
          cd $ANDROID_SDK_ROOT/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip
          unzip -q commandlinetools-linux-10406996_latest.zip
          mv cmdline-tools latest
          rm commandlinetools-linux-10406996_latest.zip
        fi
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
        yes | sdkmanager --licenses 2>/dev/null || true
        sdkmanager --install "platforms;android-33" 2>&1 | grep -i "installed" || true
        sdkmanager --install "build-tools;33.0.0" 2>&1 | grep -i "installed" || true
        sdkmanager --install "platform-tools" 2>&1 | grep -i "installed" || true
        sdkmanager --install "ndk;25.1.8387110" 2>&1 | grep -i "installed" || true

    - name: Verify Environment
      run: |
        java -version
        python --version
        test -f buildozer.spec && echo "buildozer.spec found" || echo "ERROR: buildozer.spec missing"

    - name: Cache Gradle
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: gradle-${{ runner.os }}-api-33
        restore-keys: gradle-${{ runner.os }}-

    - name: Cache Buildozer State
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          .buildozer
        key: buildozer-state-${{ runner.os }}-api-33
        restore-keys: buildozer-state-${{ runner.os }}-

    - name: Cache Android SDK
      uses: actions/cache@v3
      with:
        path: /usr/local/lib/android/sdk
        key: android-sdk-api-33-ndk-25b
        restore-keys: android-sdk-

    - name: Install Build Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install Cython==0.29.33
        python -m pip install buildozer kivy pillow

    - name: Clean Previous Builds
      run: buildozer android clean || true
    - name: Clean Previous Builds
      run: buildozer android clean

    # First run a debug build (no signing) to catch issues quickly
    - name: Build Debug APK (helpful to reproduce failures)
      run: |
        set -o pipefail
        retry() { n=0; until [ "$n" -ge 2 ]; do "$@" && break || n=$((n+1)) && echo "Retry #$n..." && sleep $((n*10)); done }
        retry buildozer android debug 2>&1 | tee build-debug.log || true

    - name: Upload Debug Build Log
      uses: actions/upload-artifact@v3
      with:
        name: projectmind-debug-log-${{ github.run_number }}
        path: build-debug.log
        retention-days: 14

    # If debug built an apk, upload it for quick testing
    - name: Upload Debug APK (if present)
      uses: actions/upload-artifact@v3
      with:
        name: projectmind-debug-apk-${{ github.run_number }}
        path: bin/*debug*.apk
        retention-days: 7

    # Now attempt the release build (signed requirement - may fail without secrets)
    - name: Build Release APK
      run: |
        set -o pipefail
        retry() { n=0; until [ "$n" -ge 2 ]; do "$@" && break || n=$((n+1)) && echo "Retry #$n..." && sleep $((n*10)); done }
        retry buildozer android release 2>&1 | tee build.log || true

    - name: Verify Release APK
      run: test -f bin/projectmind-1.0.0-release.apk && echo "APK created successfully" || echo "No release APK found"

    - name: Upload Release APK
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: projectmind-apk-${{ github.run_number }}
        path: bin/projectmind-*.apk
        retention-days: 30

    # Always upload build logs for diagnosis
    - name: Upload Build Logs (always)
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: projectmind-build-logs-${{ github.run_number }}
        path: |
          build-debug.log
          build.log
          buildozer.log
          .buildozer/android/platform/*/build.log
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        echo "==== Build summary ===="
        if [ -f "bin/projectmind-1.0.0-release.apk" ]; then
          echo "APK Status: SUCCESS"
          du -h bin/projectmind-1.0.0-release.apk || true
        elif ls bin/*debug*.apk 1> /dev/null 2>&1; then
          echo "APK Status: DEBUG APK built"
          ls -l bin/*debug*.apk || true
        else
          echo "APK Status: FAILED"
          echo "--- Last 800 lines of build.log (if present) ---"
          if [ -f build.log ]; then
            tail -n 800 build.log || true
          fi
          echo "--- Last 800 lines of build-debug.log (if present) ---"
          if [ -f build-debug.log ]; then
            tail -n 800 build-debug.log || true
          fi
        fi
