name: Advanced Android APK Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  ANDROID_HOME: /usr/local/lib/android/sdk
  ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.1.8387110
  GRADLE_USER_HOME: ~/.gradle
  GRADLE_OPTS: -Xmx2048m -XX:MaxPermSize=512m

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Create Cache Directories (Defensive)
      run: |
        echo "Creating required cache directories..."
        mkdir -p "$HOME/.gradle/wrapper" "$HOME/.gradle/caches" "$HOME/.cache/pip" || true
        mkdir -p "$GRADLE_USER_HOME" || true

    - name: Restore Gradle Cache (Non-Fatal)
      id: restore-gradle-cache
      uses: actions/cache@v4
      continue-on-error: true
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties','**/*.gradle*') }}
        restore-keys: |
          gradle-${{ runner.os }}-

    - name: Detect and Clear Corrupted Cache
      if: steps.restore-gradle-cache.outcome == 'failure' || steps.restore-gradle-cache.conclusion == 'failure'
      run: |
        echo "Cache restore failed - removing potential corrupted cache folders and continuing"
        rm -rf ~/.gradle/caches || true
        rm -rf ~/.gradle/wrapper || true

    - name: Restore pip Cache (Non-Fatal)
      id: restore-pip-cache
      uses: actions/cache@v4
      continue-on-error: true
      with:
        path: ~/.cache/pip
        key: pip-${{ runner.os }}-py3.11-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          pip-${{ runner.os }}-py3.11-

    - name: Install Python Dependencies Safely
      run: |
        echo "Upgrading pip and installing dependencies..."
        python -m pip install --upgrade pip setuptools wheel --no-cache-dir
        python -m pip install Cython==0.29.33 --no-cache-dir
        python -m pip install buildozer --no-cache-dir
        python -m pip install kivy==2.1.0 pillow numpy flask requests --no-cache-dir

    - name: Verify Environment Setup
      run: |
        echo "=== Environment Verification ==="
        echo "Current directory: $(pwd)"
        echo "Directory listing:"
        ls -la
        
        echo ""
        echo "=== Python Environment ==="
        python --version
        pip list | grep -E "buildozer|Cython|kivy|Pillow|numpy|flask|requests"
        
        echo ""
        echo "=== Java Environment ==="
        java -version
        javac -version
        
        echo ""
        echo "=== Buildozer Setup ==="
        buildozer --version

    - name: Prepare Buildozer Configuration
      run: |
        echo "=== Preparing Buildozer Configuration ==="
        # Check if buildozer.spec exists in root
        if [ -f "buildozer.spec" ]; then
          echo "buildozer.spec found in root directory"
        elif [ -f "scripts/buildozer.spec" ]; then
          echo "buildozer.spec found in scripts directory, copying to root"
          cp scripts/buildozer.spec .
        else
          echo "ERROR: buildozer.spec not found in root or scripts directory"
          echo "Available files:"
          find . -name "*.spec" -type f
          exit 1
        fi
        
        # Verify source directory exists
        echo "Checking source directory..."
        if [ -d "app/src" ]; then
          echo "Source directory app/src found"
          ls -la app/src/
        else
          echo "ERROR: Source directory app/src not found"
          echo "Available directories:"
          find . -type d -maxdepth 2
          exit 1
        fi

    - name: Clean Previous Builds (Fresh Start)
      run: |
        echo "Cleaning previous build artifacts..."
        buildozer android clean || echo "Clean completed (no previous build found)"

    - name: Build Release APK (Verbose)
      id: build
      run: |
        echo "=== Starting APK Build ==="
        echo "Current directory: $(pwd)"
        echo "Buildozer spec contents:"
        head -20 buildozer.spec
        
        # Build with verbose output and error handling
        set -o pipefail
        buildozer -v android release 2>&1 | tee build.log
        BUILD_EXIT=$?
        
        if [ $BUILD_EXIT -ne 0 ]; then
          echo "Build failed with exit code: $BUILD_EXIT"
          echo "Showing last 200 lines of build log:"
          tail -200 build.log
          
          # Show full log if build failed
          echo "=== FULL BUILD LOG ==="
          cat build.log
          exit $BUILD_EXIT
        else
          echo "Build completed successfully!"
        fi

    - name: Find APK Files
      id: find-apk
      run: |
        echo "=== Searching for APK files ==="
        # Search in multiple possible locations
        APK_PATHS=(
          "bin/*.apk"
          ".buildozer/android/platform/build-*/dists/*/bin/*.apk"
          ".buildozer/android/platform/build-arm*/dists/*/bin/*.apk"
          ".buildozer/android/app/build/outputs/**/*.apk"
          "**/*release*.apk"
          "**/*.apk"
        )
        
        FOUND_APKS=()
        for pattern in "${APK_PATHS[@]}"; do
          echo "Searching for APKs with pattern: $pattern"
          # Use find to locate APK files
          while IFS= read -r -d '' apk; do
            if [ -f "$apk" ]; then
              echo "Found APK: $apk"
              FOUND_APKS+=("$apk")
            fi
          done < <(find . -path "$pattern" -type f -print0 2>/dev/null || true)
        done
        
        if [ ${#FOUND_APKS[@]} -eq 0 ]; then
          echo "WARNING: No APK files found"
          echo "contents_of_build_directory=none" >> $GITHUB_OUTPUT
        else
          echo "Found ${#FOUND_APKS[@]} APK file(s):"
          for apk in "${FOUND_APKS[@]}"; do
            echo "  - $apk ($(du -h "$apk" | cut -f1))"
          done
          echo "contents_of_build_directory=${FOUND_APKS[0]}" >> $GITHUB_OUTPUT
        fi
        
        # List all files in build directories for debugging
        echo "=== Build Directory Contents ==="
        find . -path "*/build*" -type d | while read dir; do
          echo "Directory: $dir"
          ls -la "$dir" 2>/dev/null || echo "Cannot list $dir"
        done

    - name: Upload APK Artifacts (Safe)
      uses: actions/upload-artifact@v4
      with:
        name: projectmind-apk-${{ github.run_number }}
        path: |
          bin/*.apk
          .buildozer/android/platform/build-*/dists/*/bin/*.apk
          .buildozer/android/platform/build-arm*/dists/*/bin/*.apk
          .buildozer/android/app/build/outputs/**/*.apk
          **/*release*.apk
          **/*.apk
        if-no-files-found: warn
        retention-days: 30

    - name: Save Build Log Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.run_number }}
        path: |
          build.log
          .buildozer/**/*.log
        if-no-files-found: warn
        retention-days: 7

    - name: Build Summary
      if: always()
      run: |
        echo "=== BUILD SUMMARY ==="
        echo "Job Status: ${{ job.status }}"
        echo "Runner OS: ${{ runner.os }}"
        echo "Python Version: $(python --version)"
        echo "Buildozer Version: $(buildozer --version)"
        
        if [ -f "build.log" ]; then
          echo ""
          echo "=== Build Statistics ==="
          echo "Lines in build log: $(wc -l < build.log)"
          echo "Errors in build log: $(grep -i "error\|failed\|exception" build.log | wc -l)"
        fi