name: Android CI - Build APK (Resilient)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Allow apps to detect CI if needed
      CI: true

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Ensure gradlew is executable
      run: chmod +x ./gradlew || true

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Create common cache directories (defensive)
      run: |
        mkdir -p "$HOME/.gradle/wrapper" "$HOME/.gradle/caches" "$HOME/.cache/pip" || true

    - name: Try restore Gradle cache (non-fatal)
      id: restore-gradle-cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties','**/*.gradle*') }}
        restore-keys: |
          gradle-${{ runner.os }}-
      # if cache extraction fails (tar exit code 2), do not fail the job here
      continue-on-error: true

    - name: Detect corrupted cache and clear if tar failed
      if: steps.restore-gradle-cache.outcome == 'failure' || steps.restore-gradle-cache.conclusion == 'failure'
      run: |
        echo "Cache restore failed — removing potential corrupted cache folders and continuing"
        rm -rf ~/.gradle/caches || true
        rm -rf ~/.gradle/wrapper || true

    - name: (Optional) Setup Python/Buildozer prerequisites (if using Buildozer)
      if: contains(github.event.head_commit.message, 'buildozer') || true
      run: |
        python -m pip install --upgrade pip
        mkdir -p /home/runner/.cache/pip

    - name: Install dependencies (native)
      run: |
        # If your project uses other languages/platforms, add steps here
        echo "No-op install step — modify for your repo if required"

    - name: Verify Gradle & Java Versions
      run: |
        java -version || true
        ./gradlew --version || true

    - name: Build Release APK (try with cache)
      id: build
      run: |
        set -o pipefail
        # attempt a normal release build. If you use different path, change below
        ./gradlew clean assembleRelease --stacktrace --info

    - name: Upload APK artifacts (safe)
      uses: actions/upload-artifact@v4
      with:
        name: release-apks
        path: |
          app/build/outputs/apk/**/*release*.apk
          android/app/build/outputs/apk/**/*release*.apk
          **/app-release-unsigned.apk
          .buildozer/android/platform/build-arm*/dists/*/bin/*.apk
          .buildozer/android/app/build/outputs/**/*.apk
          bin/**/*.apk
        if-no-files-found: warn

    - name: Save build log artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: |
          build/*.log
          app/build/outputs/**/*log*
          app/build/outputs/**/*.txt
          .buildozer/**/*.log
        if-no-files-found: warn

  # A helper job to clear GitHub cache via key bump (optional for maintainers)
  clear-cache:
    runs-on: ubuntu-latest
    if: false
    steps:
      - run: echo "To clear cache, change the cache key or go to Actions -> Your workflow -> Clear caches"