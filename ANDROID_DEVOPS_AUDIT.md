# Android DevOps Audit Report - Project Mind

## PROJECT STRUCTURE ANALYSIS

### Current Setup
- **Type**: Python/Kivy Mobile Framework
- **Build Tool**: Buildozer (not Gradle)
- **Target**: Android 13+ (API 33)
- **Entry Point**: org.renpy.android.PythonActivity
- **Architecture**: arm64-v8a, armeabi-v7a (64-bit + 32-bit)

### Why GitHub Actions Fails (Root Causes)

1. **Missing Android SDK/NDK**: Buildozer requires these tools to compile Kivy to native code
2. **Incomplete Dependencies**: Gradle wrapper not configured (it's Buildozer's job)
3. **Memory Issues**: 1GB Gradle JVM limit insufficient for full build
4. **No Caching**: Every build downloads ~2GB of tools from scratch
5. **Wrong Java Version**: Buildozer expects Java 11+, but GitHub Actions may use Java 8
6. **Missing Build Tools**: SDK components not pre-installed
7. **Gradle/Gradle Wrapper**: Buildozer manages this internally, conflicts occur

---

## COMPONENT COMPATIBILITY MATRIX

### Current Configuration Analysis

| Component | Current | Required | Status |
|-----------|---------|----------|--------|
| **Java Version** | 11 | 11+ | ✓ OK |
| **Android API** | 33 | 24+ | ✓ OK |
| **NDK Version** | 25b | 21+ | ✓ OK |
| **Build Tools** | Not specified | 33.0.0+ | ⚠ MISSING |
| **CMake** | Not specified | Optional | ✓ OK |
| **Gradle Version** | Auto (Buildozer) | 7.0+ | ✓ OK (Buildozer) |
| **AGP (Android Gradle Plugin)** | Auto (Buildozer) | 7.0+ | ✓ OK (Buildozer) |

---

## REQUIRED ANDROID TOOLS CHECKLIST

### In GitHub Actions, These MUST Be Installed:

1. **Java Development Kit 17** (LTS, recommended for modern builds)
   - For compilation and Gradle
   - Buildozer uses this

2. **Android SDK**
   - API 33 (targetSdkVersion)
   - Build tools 33.0.0+
   - Platforms package

3. **Android NDK**
   - Version 25b (specified in buildozer.spec)
   - Required to compile native code

4. **Gradle**
   - Buildozer internally uses Gradle
   - Version 8.0+ recommended

5. **CMake** (Optional)
   - Only if using native code
   - Not needed for Kivy

---

## COMMON GITHUB ACTIONS ERRORS FOR BUILDOZER

### Error 1: "NDK not found"
```
Error: Could not determine the path to the Android NDK
```
**Fix**: GitHub Actions must set ANDROID_NDK_HOME environment variable

### Error 2: "SDK not found"
```
Error: Could not determine the path to the Android SDK
```
**Fix**: GitHub Actions must install Android SDK components before build

### Error 3: "Build tools not found"
```
Error: Build-tools version 33.0.0 not found in /android-sdk
```
**Fix**: Use `sdkmanager` to install specific build-tools version

### Error 4: "No compatible version of Gradle found"
```
Could not find matching gradle-wrapper.properties
```
**Fix**: Buildozer generates this - ensure gradle cache is cleared on first run

### Error 5: "Java version mismatch"
```
error: target type int is not allowed here (Java 8 syntax used)
```
**Fix**: Set Java 17 (or 11 minimum)

### Error 6: "Memory insufficient"
```
Error: GC overhead limit exceeded
```
**Fix**: Increase Gradle JVM memory (already in buildozer.spec: -Xmx1024m)
Update to: -Xmx2048m for larger projects

### Error 7: "Permission denied"
```
permission denied: ./gradlew
```
**Fix**: GitHub Actions must make gradlew executable

### Error 8: "Gradle cache pollution"
```
Could not open Gradle root properties cache
```
**Fix**: Clear ~/.gradle cache on each build run

---

## BUILDOZER.SPEC OPTIMIZATION FOR CI/CD

### Current Issues Found

1. ❌ **Missing build-tools specification**
   - Should explicitly set: `android.gradle_options = org.gradle.java.home=/path/to/java`

2. ❌ **No release signing configured**
   - Buildozer needs signing key for release builds
   - Must be provided as environment variables or keystore file

3. ⚠️ **NDK version 25b compatibility**
   - Works but newer NDK (26+) has better performance
   - Stick with 25b for stability

4. ⚠️ **Gradle memory limited to 1GB**
   - Acceptable for Kivy
   - May need 2GB+ for larger projects

5. ✓ **API levels correct**
   - minapi=33, api=33: Perfect for modern Android

### Recommended buildozer.spec Updates

```ini
# Build memory optimization
android.gradle_options = org.gradle.jvmargs=-Xmx2048m

# Enable gradle caching
android.gradle_options = org.gradle.caching=true

# SDK components specification (for CI/CD clarity)
android.sdk_path = {ANDROID_SDK_ROOT}
android.ndk_path = {ANDROID_NDK_ROOT}
```

---

## GRADLE CONFIGURATION (Generated by Buildozer)

### What Buildozer Automatically Creates:

1. **build.gradle** (Project level)
   - Plugins: com.android.tools.build:gradle
   - Repositories: Google, MavenCentral
   - Dependencies: Kivy, Python runtime

2. **app/build.gradle** (Module level)
   - compileSdkVersion: 33
   - minSdkVersion: 21 (for Kivy compatibility)
   - targetSdkVersion: 33
   - versionCode: 1
   - versionName: 1.0.0

3. **gradle-wrapper.properties**
   - Gradle version: 8.0+
   - Auto-generated by Buildozer

4. **AndroidManifest.xml**
   - Auto-generated with permissions from buildozer.spec
   - Entry point: org.renpy.android.PythonActivity

### Why You Don't See These Files:
- Buildozer generates them in `.buildozer/` temporary directory
- They're created during build, not checked into git
- This is normal for Buildozer projects

---

## JAVA COMPATIBILITY MATRIX

| Java Version | Gradle 7 | Gradle 8 | AGP 7 | AGP 8 | Status |
|-------------|----------|----------|-------|-------|--------|
| Java 8 | ✓ | ✗ | ✓ | ✗ | Legacy |
| Java 11 | ✓ | ✓ | ✓ | ✓ | **Compatible** |
| Java 17 | ✓ | ✓ | ✓ | ✓ | **Recommended** |
| Java 21 | ✗ | ✓ | ✗ | ✓ | Newest |

**For Project Mind**: Java 17 is optimal (good balance of modern features and compatibility)

---

## NDK & SDK DEPENDENCY MATRIX

| NDK Version | Gradle | AGP | min API | Status |
|------------|--------|-----|---------|--------|
| NDK 21 | 6.0+ | 4.0+ | 16 | Legacy |
| NDK 23 | 7.0+ | 7.0+ | 16 | Good |
| NDK 25b | 8.0+ | 8.0+ | 16 | **Optimal** |
| NDK 26 | 8.0+ | 8.0+ | 16 | Newest |

**Project Mind**: NDK 25b is perfect for your setup

---

## SIGNING CONFIGURATION FOR RELEASE BUILDS

### Current Issue
- No signing configuration in buildozer.spec
- Release APK cannot be signed
- GitHub Actions has no key management

### Solution for GitHub Actions
1. Generate keystore locally (done once)
2. Encode keystore as base64
3. Store in GitHub Secrets
4. Decode and use in CI/CD

### Steps to Generate Release Keystore

```bash
# Generate keystore (do this ONCE locally, not in CI/CD)
keytool -genkey -v -keystore projectmind.jks \
  -keyalg RSA -keysize 2048 -validity 10000 \
  -alias projectmind_key
```

Store the .jks file and password securely in GitHub Secrets:
- `RELEASE_KEYSTORE_BASE64`: Base64-encoded keystore
- `RELEASE_KEYSTORE_PASSWORD`: Keystore password
- `RELEASE_KEY_ALIAS`: Key alias (default: projectmind_key)
- `RELEASE_KEY_PASSWORD`: Key password (usually same as keystore password)

---

## GITHUB ACTIONS REQUIREMENTS

### For Buildozer to Build Successfully:

1. **Java 17** (or 11+)
   - Command: `setup-java@v3`
   - Distribution: temurin (or eclipse-temurin)

2. **Python 3.11+**
   - Command: `setup-python@v4`
   - Version: 3.11 or 3.12

3. **Android SDK**
   - Install via: `android-sdk-action` or `sdkmanager`
   - Components:
     - platforms;android-33
     - build-tools;33.0.0
     - platform-tools
     - ndk;25.1.8387110 (matches NDK 25b)

4. **Buildozer**
   - Install: `pip install buildozer cython==0.29.33`
   - Cython version is CRITICAL (Kivy requirement)

5. **Dependencies**
   - Kivy: Installed by buildozer requirements
   - Pillow: Listed in buildozer.spec
   - Other Python packages: Via requirements

---

## FILE STRUCTURE EXPLANATION

### For Buildozer Projects (Kivy):

```
Project Mind/
├── buildozer.spec                    # Buildozer configuration (KEY FILE)
├── kivy_main.py                      # Kivy app entry point
├── src/                              # Python source code
│   ├── main.py
│   ├── types.py
│   └── ... (other modules)
├── data/                             # Data files
│   └── mind_heart.json
├── .github/
│   └── workflows/
│       └── build-apk.yml             # GitHub Actions workflow (KEY FILE)
├── .buildozer/                       # Buildozer temporary files (generated)
│   ├── android/
│   │   ├── .gradle/                  # Gradle cache
│   │   ├── app/                      # Generated Android app
│   │   │   └── build.gradle          # (Generated by Buildozer)
│   │   │   └── build/                # Build output
│   │   │       └── outputs/
│   │   │           └── apk/
│   │   │               └── release/
│   │   │                   └── app-release.apk  # FINAL APK
│   │   ├── settings.gradle           # (Generated by Buildozer)
│   │   ├── gradle-wrapper.jar        # (Generated by Buildozer)
│   │   └── gradle-wrapper.properties # (Generated by Buildozer)
├── bin/                              # Build output (Buildozer copies here)
│   └── projectmind-1.0.0-release.apk # FINAL APK for distribution
```

### Key Points:
- **buildozer.spec** is your source of truth
- **.buildozer/** is generated - don't edit
- **Gradle files** are auto-generated - don't manually create
- **bin/** contains final APK after build

---

## COMMON MISCONFIGURATIONS

### Mistake 1: Creating Manual build.gradle
**Problem**: You create build.gradle manually, conflicts with Buildozer's generation
**Fix**: Never create Gradle files - let Buildozer generate them

### Mistake 2: Wrong API Level
**Problem**: `android.api = 30` but trying to use API 33 features
**Fix**: Match api with targetSdk in your code, set to 33+

### Mistake 3: Missing minSdk
**Problem**: No minSdk specified, defaults to too low
**Fix**: Buildozer uses sensible default (21), acceptable for Kivy

### Mistake 4: Conflicting Requirements
**Problem**: `requirements = python3,kivy,pillow` but also trying to add gradle dependencies
**Fix**: Keep buildozer.spec as single source - all dependencies declared there

### Mistake 5: No Environment Variables
**Problem**: GitHub Actions doesn't set ANDROID_SDK_ROOT, ANDROID_NDK_HOME
**Fix**: GitHub Actions must set these before calling buildozer

### Mistake 6: Gradle Wrapper Permission
**Problem**: `gradlew` is not executable in GitHub Actions
**Fix**: GitHub Actions must run `chmod +x gradlew` or Buildozer handles it

---

## VALIDATION CHECKLIST FOR GITHUB ACTIONS

- [ ] Java 17 installed
- [ ] Python 3.11+ installed
- [ ] Android SDK installed (API 33)
- [ ] Build tools installed (33.0.0+)
- [ ] Android NDK installed (25b)
- [ ] ANDROID_SDK_ROOT environment variable set
- [ ] ANDROID_NDK_HOME environment variable set
- [ ] Buildozer installed
- [ ] Cython==0.29.33 installed (exact version)
- [ ] buildozer.spec exists and valid
- [ ] kivy_main.py exists and has no syntax errors
- [ ] All Python modules in src/ are importable
- [ ] Permissions declared in buildozer.spec
- [ ] Gradle memory set to 2GB+ for larger projects
- [ ] Gradle cache enabled for faster builds

---

## PERFORMANCE OPTIMIZATION

### First Build (Cold Start): 15-20 minutes
- Downloads NDK: 2GB
- Downloads Gradle: 500MB
- Compiles native Python: 10 minutes
- Builds APK: 5 minutes

### Subsequent Builds (Warm): 5-10 minutes
- Reuses cached NDK, Gradle, SDK
- Only rebuilds changed code
- Gradle cache hit

### Caching Strategy for GitHub Actions
```yaml
- name: Cache Gradle
  uses: actions/cache@v3
  with:
    path: ~/.gradle/caches
    key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle.properties') }}

- name: Cache Android SDK
  uses: actions/cache@v3
  with:
    path: ~/android-sdk
    key: android-sdk-${{ runner.os }}-api-33

- name: Cache Buildozer
  uses: actions/cache@v3
  with:
    path: .buildozer
    key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
```

---

## TESTING LOCALLY BEFORE CI/CD

### Step 1: Install Buildozer Locally
```bash
pip install buildozer cython==0.29.33
```

### Step 2: Validate buildozer.spec
```bash
python validate_build.py  # Your existing validation script
```

### Step 3: Clean Previous Builds
```bash
buildozer android clean
```

### Step 4: Debug Build
```bash
buildozer android debug
```

### Step 5: Release Build
```bash
buildozer android release
```

### Step 6: Check Output
```bash
ls -la bin/  # Find projectmind-1.0.0-release.apk
```

---

## TROUBLESHOOTING GITHUB ACTIONS BUILD

### If Build Fails at "Downloading NDK"
```
❌ Error: Failed to download NDK
```
**Solutions**:
1. Increase timeout to 45 minutes
2. Check internet connection in GitHub (shouldn't be issue)
3. Reduce NDK size - use NDK 23 instead of 25b (not recommended)

### If Build Fails at "Gradle Compilation"
```
❌ Error: Gradle build failed
```
**Solutions**:
1. Check Java version (must be 11+, recommend 17)
2. Increase Gradle memory: `-Xmx2048m`
3. Clear Gradle cache: `rm -rf ~/.gradle`
4. Enable verbose logging: `buildozer android release -- --debug`

### If Build Fails at "Manifest Merger"
```
❌ Error: Manifest merger failed
```
**Solutions**:
1. Check all permissions in buildozer.spec are valid Android permissions
2. Ensure no duplicate permissions
3. Check for conflicting requirements (e.g., both CAMERA and camera)

### If APK is Not Created
```
❌ Error: No APK generated in bin/
```
**Solutions**:
1. Check build succeeded (look for "Build successful" message)
2. Check bin/ directory path is correct
3. Run: `find .buildozer -name "*.apk"`

---

## SUMMARY & NEXT STEPS

### What Will Fix Your GitHub Actions Builds:

1. ✓ Updated buildozer.spec with correct settings
2. ✓ Professional GitHub Actions workflow with all tools
3. ✓ Proper environment variable configuration
4. ✓ Gradle caching for speed
5. ✓ Proper timeout and memory allocation
6. ✓ Artifact upload for easy testing

### You'll Receive:

1. **Updated buildozer.spec** - Fixed and optimized
2. **Production GitHub Actions Workflow** - build-apk.yml
3. **Setup Instructions** - For signing and secrets
4. **Testing Guide** - How to validate locally
5. **Troubleshooting Guide** - For common errors

### Expected Results:

- ✅ First build: ~18 minutes
- ✅ Subsequent builds: ~7 minutes
- ✅ APK available as GitHub artifact
- ✅ No missing parameters
- ✅ Build logs clearly show success/failure

---

**Generated by: Android DevOps Engineer**
**Date**: December 9, 2025
**Project**: Project Mind - Living AI for Android
